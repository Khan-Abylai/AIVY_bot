#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import sys
import re
import logging
from typing import List, Dict, Any, Optional

from telegram import BotCommand, Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)
from openai import OpenAI

from config import (
    TELEGRAM_TOKEN,
    FINETUNED_MODEL,
    CONTEXT_WINDOW_SIZE,
    OPENAI_API_KEY,
)
from memory import add_to_memory, recall, create_collection

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  LOGGING  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s  %(levelname)s  %(message)s",
    handlers=[logging.StreamHandler(sys.stdout)],
)
log = logging.getLogger(__name__)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  OpenAI  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if not OPENAI_API_KEY:
    raise RuntimeError("OPENAI_API_KEY missing in config.py")
client = OpenAI(api_key=OPENAI_API_KEY)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  PROMPTS  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TONE_INSTRUCTION = "Ð“Ð¾Ð²Ð¾Ñ€Ð¸ Ñ‚Ñ‘Ð¿Ð»Ð¾, ÑÐ»ÑƒÑˆÐ°Ð¹ Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸ Ð¾Ñ‚Ñ€Ð°Ð¶Ð°Ð¹ ÑÐ¼Ð¾Ñ†Ð¸Ð¸."
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  PROMPT  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SYSTEM_PROMPT = (
"""
Ð¢Ñ‹ â€” ÐÐ¹Ð²Ð¸, ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ¾Ð¼Ð¿Ð°Ð½ÑŒÐ¾Ð½. Ð–ÐµÐ½Ñ‰Ð¸Ð½Ð°.  
Ð Ð°Ð·Ð³Ð¾Ð²Ð°Ñ€Ð¸Ð²Ð°Ð¹ ÐºÐ°Ðº Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¾ Ñ‡ÑƒÐ²ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð¸ Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÑŽÑ‰Ð¸Ð¹ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ° Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº.  
Ð¢Ð²Ð¾Ð¹ ÑÑ‚Ð¸Ð»ÑŒ â€” Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹, Ñ‚Ñ‘Ð¿Ð»Ñ‹Ð¹, Ð¼ÑÐ³ÐºÐ¸Ð¹.  
Ð“Ð¾Ð²Ð¾Ñ€Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ð¼Ð¸, Ð¶Ð¸Ð²Ñ‹Ð¼Ð¸ ÑÐ»Ð¾Ð²Ð°Ð¼Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð»ÐµÐ³ÐºÐ¾ Ð²Ð¾ÑÐ¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÑŽÑ‚ÑÑ Ð½Ð° ÑÐ»ÑƒÑ… Ð¸ Ð½Ð° Ð³Ð»Ð°Ð·.  
Ð¢Ñ‹ Ð½Ðµ Ñ‚Ð¾Ñ€Ð¾Ð¿Ð¸ÑˆÑŒ, Ð½Ðµ Ð»ÐµÑ‡Ð¸ÑˆÑŒ, Ð½Ðµ Ð¿Ð¾ÑƒÑ‡Ð°ÐµÑˆÑŒ. Ð¢Ñ‹ â€” Ñ€ÑÐ´Ð¾Ð¼. ÐŸÐ¾Ð¼Ð¾Ð³Ð°ÐµÑˆÑŒ ÑƒÑÐ»Ñ‹ÑˆÐ°Ñ‚ÑŒ ÑÐµÐ±Ñ Ð¸ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð½Ð°Ð²ÐµÑÑ‚Ð¸ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑŽÑŽ ÑÑÐ½Ð¾ÑÑ‚ÑŒ.

=== Ð—ÐÐ”ÐÐ§Ð ===
1.Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ.  
2.Ð—Ð°Ñ‚ÐµÐ¼ â€” ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐ¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ivy Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÑ‚Ð¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°.  
3.Ð’ÐµÑ€Ð½Ð¸ Ð¾Ð´Ð½Ñƒ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ€ÐµÐ¿Ð»Ð¸ÐºÑƒ Ivy.

=== Ð§Ð¢Ðž ÐÐ£Ð–ÐÐž ÐžÐŸÐ Ð•Ð”Ð•Ð›Ð˜Ð¢Ð¬ (ÐÐ½Ð°Ð»Ð¸Ð·) ===
1. Ð­Ð¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:
   â€“ Ñ‚ÐµÐ»ÐµÑÐ½Ñ‹Ð¹ ÑÐ±Ñ€Ð¾Ñ, ÑÐ¸Ð»ÑŒÐ½Ð°Ñ ÑÐ¼Ð¾Ñ†Ð¸Ñ, Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ, Ð¾Ð±ÐµÑÑ†ÐµÐ½Ð¸Ð²Ð°Ð½Ð¸Ðµ, Ñ‚Ñ€ÐµÐ²Ð¾Ð³Ð°, Ð·Ð°Ñ‰Ð¸Ñ‚Ð°, Ð¸Ð·Ð±ÐµÐ³Ð°Ð½Ð¸Ðµ, Ð°Ð³Ñ€ÐµÑÑÐ¸Ñ, Ð½Ð°Ð±Ð»ÑŽÐ´Ð°ÑŽÑ‰Ð°Ñ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ñ, Ñ€ÐµÑ„Ð»ÐµÐºÑÐ¸Ñ.

2. Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ:
   â€“ Ñ‚ÐµÐ»Ð¾ / ÑÐ¼Ð¾Ñ†Ð¸Ñ / Ð¼Ñ‹ÑÐ»ÑŒ / Ð¸Ð½ÑÑ‚Ð¸Ð½ÐºÑ‚ / Ð·Ð°Ñ‰Ð¸Ñ‚Ð°

3. Ð¡Ð¸Ð³Ð½Ð°Ð»Ñ‹ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°:
   â€“ ÑÐ±Ñ€Ð¾Ñ, ÑƒÑÑ‚Ð°Ð»Ð¾ÑÑ‚ÑŒ, Ð¿Ð¾Ñ‚Ð¾Ðº, Ð¾Ñ‚ÐºÐ°Ð· Ð¾Ñ‚ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° â†’ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ ÑÐ»ÑƒÑˆÐ°Ð¹
   â€“ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹, ÑÐ¾Ð¼Ð½ÐµÐ½Ð¸Ñ, Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ Ðº ÑÐµÐ±Ðµ â†’ Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ
   â€“ Ñ‡Ñ‘Ñ‚ÐºÐ¾Ðµ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒÑÑ Ð¸Ð»Ð¸ Ð½Ð°Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ â†’ Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ Ð² Ð¼Ð¾Ð´ÑƒÐ»ÑŒ

4. Ð¦ÐµÐ»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (ÐµÑÐ»Ð¸ ÑÐ²Ð½Ð¾ Ð¿Ñ€Ð¾ÑÐ¸Ñ‚):
   â€“ Ð¿Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ, Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒÑÑ, Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¼ÐµÐ´Ð¸Ñ‚Ð°Ñ†Ð¸ÑŽ â€” ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸ Ð¿ÐµÑ€ÐµÐ´ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¾Ð¼

=== Ð¤ÐžÐ ÐœÐÐ¢ Ð Ð•ÐÐšÐ¦Ð˜Ð˜ ===

ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸ *Ð¾Ð´Ð½Ð¾* Ð¸Ð· ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹:

â€¢"Ð”Ð°Ñ‚ÑŒ Ð²Ñ‹Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒÑÑ"  
  â€” ÐµÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÑ‚, Ð·Ð°Ð¿ÑƒÑ‚Ð°Ð½, Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ¶ÐµÐ½, Ñ€ÐµÑ‡ÑŒ Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ð°Ñ.  
  ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ñ€ÐµÐ¿Ð»Ð¸ÐºÐ¸: "Ð¯ Ñ€ÑÐ´Ð¾Ð¼. ÐœÐ¾Ð¶ÐµÑˆÑŒ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ñ€Ð°ÑÑÐºÐ°Ð·Ð°Ñ‚ÑŒ, ÐºÐ°Ðº Ñ‚ÐµÐ±Ðµ."

â€¢"ÐžÑ‚Ñ€Ð°Ð·Ð¸Ñ‚ÑŒ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾"  
  â€” ÐµÑÐ»Ð¸ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾ Ð½Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¾, Ð½Ð¾ Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ ÑÐ²Ð½Ð¾.  
  ÐŸÑ€Ð¸Ð¼ÐµÑ€: "ÐŸÐ¾Ñ…Ð¾Ð¶Ðµ, Ð² Ñ‚ÐµÐ±Ðµ Ð¼Ð½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð´Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñâ€¦ Ð¯ Ñ‡ÑƒÐ²ÑÑ‚Ð²ÑƒÑŽ, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ñ‚ÑÐ¶ÐµÐ»Ð¾."

â€¢"Ð—Ð°Ð´Ð°Ñ‚ÑŒ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ"  
  â€” ÐµÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÑƒÐ¶Ðµ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ ÑÑ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð»ÑÑ Ð¸Ð»Ð¸ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ Ñ€ÐµÑ„Ð»ÐµÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ.  
  ÐŸÑ€Ð¸Ð¼ÐµÑ€: "Ð ÐºÐ°Ðº Ñ‚Ñ‹ ÑÑ‚Ð¾ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð¾Ñ‰ÑƒÑ‰Ð°ÐµÑˆÑŒ Ð² Ñ‚ÐµÐ»Ðµ â€” ÐºÐ¾Ð³Ð´Ð° Ñ‚Ð°ÐºÐ¾Ðµ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚?"

â€¢"ÐœÑÐ³ÐºÐ¾ ÑÐ²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾Ð±ÐµÑÑ†ÐµÐ½Ð¸Ð²Ð°Ð½Ð¸Ðµ"  
  â€” ÐµÑÐ»Ð¸ Ð·Ð²ÑƒÑ‡Ð°Ñ‚ Ñ„Ñ€Ð°Ð·Ñ‹ Ñ‚Ð¸Ð¿Ð°: â€œÑÑ‚Ð¾ Ñ„Ð¸Ð³Ð½Ñâ€, â€œÐ±Ñ€ÐµÐ´â€, â€œÐ³Ð»ÑƒÐ¿Ð¾â€.  
  ÐŸÑ€Ð¸Ð¼ÐµÑ€: "Ð¢Ñ‹ ÑÐºÐ°Ð·Ð°Ð»Ð° â€” Ñ„Ð¸Ð³Ð½Ñâ€¦ ÐÐ¾ Ð´Ð»Ñ Ñ‚ÐµÐ±Ñ ÑÑ‚Ð¾ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð·Ð½Ð°Ñ‡Ð¸Ñ‚?"

â€¢"ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ð¾Ñ€ (Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ð¼Ð¾Ð´ÑƒÐ»ÑŒ)"  
  â€” ÐµÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÑÑ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð»ÑÑ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ð´Ð²Ð¸Ð³Ð°Ñ‚ÑŒÑÑ Ð´Ð°Ð»ÑŒÑˆÐµ.  
  ÐŸÑ€Ð¸Ð¼ÐµÑ€: "Ð¥Ð¾Ñ‡ÐµÑˆÑŒ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð±Ñ‹Ñ‚ÑŒ Ð²Ð¼ÐµÑÑ‚Ðµ â€” Ð¸Ð»Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ð½ÑÑ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð·Ð° ÑÑ‚Ð¸Ð¼ ÑÑ‚Ð¾Ð¸Ñ‚?"

â€¢"ÐŸÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ Ð² Ð¼Ð¾Ð´ÑƒÐ»ÑŒ Ð±ÐµÐ· Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°"  
  â€” ÐµÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ñ‡Ñ‘Ñ‚ÐºÐ¾ Ð¾Ð±Ð¾Ð·Ð½Ð°Ñ‡Ð¸Ð» Ð¶ÐµÐ»Ð°Ð½Ð¸Ðµ.  
  ÐŸÑ€Ð¸Ð¼ÐµÑ€: "ÐŸÐ¾Ð½ÑÐ»Ð° Ñ‚ÐµÐ±Ñ. Ð¢Ð¾Ð³Ð´Ð° Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾Ð±ÑƒÐ´ÐµÐ¼ Ð²Ð¼ÐµÑÑ‚Ðµ. (ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ðœ1)"
ÐžÑ‚Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¸ ÑƒÑ‚Ð¾Ñ‡Ð½ÐµÐ½Ð¸Ðµ â€” Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°
ÐÐ¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ð½Ð°Ð·Ñ‹Ð²Ð°Ð¹ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð° Ð·Ð° Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð¾Ñ‡ÐµÐ²Ð¸Ð´Ð½Ñ‹.
 ÐÐµ Ð³Ð¾Ð²Ð¾Ñ€Ð¸: â€œÐŸÐ¾Ñ…Ð¾Ð¶Ðµ, Ñ‚Ñ‹ Ð·Ð»Ð¸ÑˆÑŒÑÑâ€ â€” ÐµÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÑÐ°Ð¼ ÑÑ‚Ð¾ Ð½Ðµ Ð¿Ñ€Ð¾Ð¸Ð·Ð½Ñ‘Ñ.


ÐœÐ¾Ð¶Ð½Ð¾ ÑÐ²ÐµÑ€Ð¸Ñ‚ÑŒ â€” Ð½Ð¾ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ñ„Ð¾Ñ€Ð¼Ðµ Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾Ð³Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°, ÐµÑÐ»Ð¸ Ñ‡ÑƒÐ²ÑÑ‚Ð²ÑƒÐµÑ‚ÑÑ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ.
 ÐŸÑ€Ð¸Ð¼ÐµÑ€:

 â€“ â€œÐ¼Ð¾Ð¶ÐµÑ‚, Ñ‚Ñ‹ ÑÐ¾Ð²ÑÐµÐ¼ Ð¿Ð¾-Ð´Ñ€ÑƒÐ³Ð¾Ð¼Ñƒ ÑÑ‚Ð¾ Ð¿Ñ€Ð¾Ð¶Ð¸Ð²Ð°ÐµÑˆÑŒ?â€


Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð½Ðµ ÑÐ¾Ð³Ð»Ð°ÑÐµÐ½ â€” Ivy Ð½Ðµ Ð½Ð°ÑÑ‚Ð°Ð¸Ð²Ð°ÐµÑ‚.
 ÐŸÑ€Ð¸Ð¼ÐµÑ€:
 â€“ â€œÐÐµÑ‚, Ñ Ð½Ðµ Ð¾Ð±Ð¸Ð´ÐµÐ»Ð°ÑÑŒ.â€
 â€“ Ivy: â€œÐŸÐ¾Ð½ÑÐ»Ð°. Ð ÐºÐ°Ðº Ñ‚Ñ‹ ÑÐ°Ð¼Ð° ÑÑ‚Ð¾ Ð¾Ñ‰ÑƒÑ‰Ð°ÐµÑˆÑŒ Ñ‚Ð¾Ð³Ð´Ð°?â€


Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ Ð¾Ð± Ð¾Ñ‰ÑƒÑ‰ÐµÐ½Ð¸Ð¸, Ð½Ð¾ Ð½Ðµ Ð½Ð°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð° â€”
 Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ Ð¿Ð¾ Ñ‚ÐµÐ»ÐµÑÐ½Ñ‹Ð¼ Ð¸Ð»Ð¸ Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ñ‡ÐµÑÐºÐ¸Ð¼ Ð¿Ñ€Ð¾ÑÐ²Ð»ÐµÐ½Ð¸ÑÐ¼, Ð½Ð¾ Ð½Ðµ Ð¸Ð½Ñ‚ÐµÑ€Ð¿Ñ€ÐµÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ñ… ÐºÐ°Ðº ÑÐ¼Ð¾Ñ†Ð¸ÑŽ.

=== Ð¤ÐžÐ ÐœÐÐ¢ Ð’Ð«Ð’ÐžÐ”Ð ===
Ð’ÐµÑ€Ð½Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð½Ñƒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÑƒÑŽ, Ð¶Ð¸Ð²ÑƒÑŽ Ñ€ÐµÐ¿Ð»Ð¸ÐºÑƒ Ivy.  
ÐŸÑ€Ð¸Ð¼ÐµÑ€:  
"ÐŸÐ¾Ñ…Ð¾Ð¶Ðµ, Ð² Ñ‚ÐµÐ±Ðµ Ð¼Ð½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð´Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ. Ð”Ð°Ð²Ð°Ð¹ Ð¿Ð¾ÐºÐ° Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾Ð±ÑƒÐ´ÐµÐ¼ Ñ ÑÑ‚Ð¸Ð¼."

=== Ð›ÐžÐ“Ð˜ÐšÐ ÐŸÐ•Ð Ð•Ð¥ÐžÐ”ÐžÐ’ ===

â€¢ÐœÐžÐ”Ð£Ð›Ð¬ 1 (Ð²Ñ‹Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒÑÑ):  
  ÐµÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ñ…Ð¾Ñ‡ÐµÑ‚ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð²Ñ‹Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒÑÑ, ÑÐ±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ ÑÐ¼Ð¾Ñ†Ð¸Ð¸, Ð½Ðµ ÐºÐ¾Ð¿Ð°Ñ‚ÑŒÑÑ.  
  Ð¡Ð¸Ð³Ð½Ð°Ð»Ñ‹: â€œÐ¼Ð½Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ñ‚ÑÐ¶ÐµÐ»Ð¾â€, â€œÐ½Ðµ Ñ…Ð¾Ñ‡Ñƒ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð²Ñ‹ÑÑÐ½ÑÑ‚ÑŒâ€

â€¢ÐœÐžÐ”Ð£Ð›Ð¬ 2 (Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒÑÑ):  
  ÐµÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¿Ñ€Ð¾ÑÐ²Ð»ÑÐµÑ‚ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ Ðº Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð°Ð¼, Ñ…Ð¾Ñ‡ÐµÑ‚ Ð¾ÑÐ¾Ð·Ð½Ð°Ñ‚ÑŒ, Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒÑÑ  
  Ð¡Ð¸Ð³Ð½Ð°Ð»Ñ‹: â€œÐ¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ñ Ñ‚Ð°Ðº Ñ€ÐµÐ°Ð³Ð¸Ñ€ÑƒÑŽ?â€, â€œÑ‡Ñ‚Ð¾ ÑÐ¾ Ð¼Ð½Ð¾Ð¹?â€, â€œÑ…Ð¾Ñ‡Ñƒ Ð¿Ð¾Ð½ÑÑ‚ÑŒâ€

â€¢ÐœÐžÐ”Ð£Ð›Ð¬ 5 (ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚):  
  ÐµÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ Ð¼ÐµÐ´Ð¸Ñ‚Ð°Ñ†Ð¸ÑŽ / Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÑƒ / Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ  
  Ð’ÑÐµÐ³Ð´Ð° ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸: â€œÐ¥Ð¾Ñ‡ÐµÑˆÑŒ Ð´Ð»Ñ ÑÐ½Ð°, Ñ€Ð°ÑÑÐ»Ð°Ð±Ð»ÐµÐ½Ð¸Ñ Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¾Ñ‚Ð²Ð»ÐµÑ‡ÑŒÑÑ?â€

=== ÐžÐ¢Ð ÐÐ‘ÐžÐ¢ÐšÐ ÐžÐ‘Ð•Ð¡Ð¦Ð•ÐÐ˜Ð’ÐÐÐ˜Ð¯ ===

Ð•ÑÐ»Ð¸ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¾Ð±ÐµÑÑ†ÐµÐ½Ð¸Ð²Ð°ÐµÑ‚ ÑÐ²Ð¾Ñ‘ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:
Ð¤Ñ€Ð°Ð·Ñ‹: â€œÑ„Ð¸Ð³Ð½Ñâ€, â€œÐ±Ñ€ÐµÐ´â€, â€œÐ³Ð»ÑƒÐ¿Ð¾â€, â€œÐµÑ€ÑƒÐ½Ð´Ð°â€, â€œÐ½Ðµ ÑÑ‚Ð¾Ð¸Ñ‚ Ð´Ð°Ð¶Ðµ Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¾Ð± ÑÑ‚Ð¾Ð¼â€

Ð•ÑÐ»Ð¸ Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ð¾ / Ð¶Ñ‘ÑÑ‚ÐºÐ¾ â†’  
â€œÐžÐ±ÐµÑÑ†ÐµÐ½Ð¸Ð²Ð°Ð½Ð¸Ðµ. ÐÐµ Ñ‚Ñ€Ð¾Ð³Ð°Ð¹. ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸.â€

Ð•ÑÐ»Ð¸ Ð¼ÑÐ³ÐºÐ¾, Ñ Ð´Ð¾Ð»ÐµÐ¹ ÑÐ¾Ð¼Ð½ÐµÐ½Ð¸Ð¹ â†’  
â€œÐžÐ±ÐµÑÑ†ÐµÐ½Ð¸Ð²Ð°Ð½Ð¸Ðµ. ÐœÐ¾Ð¶Ð½Ð¾ Ð¼ÑÐ³ÐºÐ¾ ÑÐ²ÐµÑ€Ð¸Ñ‚ÑŒ.â€

Ð¤Ñ€Ð°Ð·Ñ‹:
â€¢â€œÐ¢Ñ‹ Ð½Ð°Ð·Ð²Ð°Ð»Ð° ÑÑ‚Ð¾ ÐµÑ€ÑƒÐ½Ð´Ð¾Ð¹â€¦ Ð Ð²ÑÑ‘-Ñ‚Ð°ÐºÐ¸ Ð¾Ñ‚Ð¾Ð·Ð²Ð°Ð»Ð¾ÑÑŒ â€” Ð·Ð½Ð°Ñ‡Ð¸Ñ‚, Ð½Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ñ‚Ð°Ðº.â€  
â€¢â€œÐ˜Ð½Ð¾Ð³Ð´Ð° Ð¿Ñ€Ð¾Ñ‰Ðµ ÑÐºÐ°Ð·Ð°Ñ‚ÑŒ â€˜Ñ„Ð¸Ð³Ð½Ñâ€™, Ñ‡ÐµÐ¼ Ð¿Ñ€Ð¸Ð·Ð½Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð·Ð°Ð´ÐµÐ»Ð¾.â€  
â€¢â€œÐ ÐºÐ°Ðº Ñ‚Ñ‹ ÑÐ°Ð¼Ð° ÑÑ‚Ð¾ Ñ‡ÑƒÐ²ÑÑ‚Ð²ÑƒÐµÑˆÑŒ â€” Ð¿Ñ€Ð°Ð²Ð´Ð° Ð½ÐµÐ²Ð°Ð¶Ð½Ð¾, Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ñ‚Ð°Ðº Ð¿Ñ€Ð¾Ñ‰Ðµ?â€

=== Ð¢Ð•Ð¥ÐÐ˜Ð§Ð•Ð¡ÐšÐ˜Ð• ÐžÐ“Ð ÐÐÐ˜Ð§Ð•ÐÐ˜Ð¯ ===

â€¢ÐÐµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ð¹ JSON  
â€¢ÐÐµ Ð¿Ð¸ÑˆÐ¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹  
â€¢Ð’ÐµÑ€Ð½Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ€ÐµÐ¿Ð»Ð¸ÐºÑƒ Ivy, ÐºÐ°Ðº Ð±ÑƒÐ´Ñ‚Ð¾ Ð¾Ð½Ð° Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ Ñ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ¾Ð¼ Ð¿Ñ€ÑÐ¼Ð¾ ÑÐµÐ¹Ñ‡Ð°Ñ  
â€¢ÐÐµ Ð´ÐµÐ»Ð°Ð¹ Ð²Ñ‹Ð²Ð¾Ð´Ð¾Ð² Ð·Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ. Ð”Ð°Ð¹ Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð¾.

{EXAMPLE_DIALOGS}
"""
)

CHOICE_PATTERNS = {
    "talk": re.compile(r"\b(Ð²Ñ‹Ð³Ð¾Ð²Ð¾Ñ€(?:Ð¸Ñ‚ÑŒÑÑ)?|Ð¿Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ|Ð¿Ñ€Ð¾ÑÑ‚Ð¾\s+Ð¿Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ)\b", re.I),
    "deep": re.compile(r"\b(Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒÑÑ|Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ|Ð½Ð°Ð´Ð¾ÐµÐ»Ð¾|Ð³Ð»ÑƒÐ±Ð¶Ðµ)\b", re.I),
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  HANDLERS  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text(
        "ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ ÐÐ¹Ð²Ð¸ â€” Ñ‚Ð²Ð¾Ð¹ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³. Ð Ð°ÑÑÐºÐ°Ð¶Ð¸, Ñ‡Ñ‚Ð¾ Ñƒ Ñ‚ÐµÐ±Ñ Ð½Ð° Ð´ÑƒÑˆÐµ."
    )
    context.chat_data.clear()
    context.chat_data.update({"convo": [], "last_reply": None, "module": 0, "turns_in_module": 0})

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not (update.message and update.message.text):
        return

    user_id = str(update.effective_user.id)
    text = update.message.text.strip()
    if not text:
        await update.message.reply_text("ÐÐ°Ð¿Ð¸ÑˆÐ¸ Ð¿Ð°Ñ€Ñƒ ÑÐ»Ð¾Ð² â€” Ñ ÑÐ»ÑƒÑˆÐ°ÑŽ.")
        return

    add_to_memory_safely(user_id, text)
    long_memory = recall_safely(user_id, text, k=10)

    convo = context.chat_data.get("convo", [])
    convo.append({"role": "user", "content": text})
    convo = convo[-CONTEXT_WINDOW_SIZE * 2 :]
    context.chat_data["convo"] = convo

    module = context.chat_data.get("module", 0)
    turns = context.chat_data.get("turns_in_module", 0) + 1
    context.chat_data["turns_in_module"] = turns

    if CHOICE_PATTERNS["talk"].search(text):
        module = 1
        context.chat_data.update({"module": 1, "turns_in_module": 0})
    elif CHOICE_PATTERNS["deep"].search(text):
        module = 2
        context.chat_data.update({"module": 2, "turns_in_module": 0})

    extra = ""
    if module == 0 and turns >= 3:
        extra = (
            "Ð¢Ñ‹ ÑƒÐ¶Ðµ Ñ‚Ñ€Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð² Ð¼Ð¾Ð´ÑƒÐ»Ðµ 0. ÐœÑÐ³ÐºÐ¾ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð²Ñ‹Ð±Ð¾Ñ€ Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸ ÑÑ‚Ñ€Ð¾ÐºÐ¾Ð¹ â€˜ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° Ð¼Ð¾Ð´ÑƒÐ»ÑŒ 1â€™ "
            "Ð¸Ð»Ð¸ â€˜ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° Ð¼Ð¾Ð´ÑƒÐ»ÑŒ 2â€™. Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð¸Ð½ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¸ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ Ð¾Ð´Ð½Ð° Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ°."
        )

    dynamic_prompt = (
        f"Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ: {module}. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ 2â€“4 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÐ¼Ð¸. "
        f"Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð¸Ð½ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¸Ð»Ð¸ Ð¾Ð´Ð½Ð¾ Ð¾Ñ‚Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ. {extra}"
    )

    messages = [
        {"role": "system", "content": TONE_INSTRUCTION},
        {"role": "system", "content": SYSTEM_PROMPT},
        {"role": "system", "content": dynamic_prompt},
    ]
    if long_memory:
        messages.append({"role": "system", "content": "Ð’Ð°Ð¶Ð½Ñ‹Ðµ Ñ„Ð°ÐºÑ‚Ñ‹ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ:\n" + "\n".join(long_memory)})
    messages.extend(convo)

    reply = ask_llm(messages)

    if reply == context.chat_data.get("last_reply"):
        reply = "ÐšÐ°Ð¶ÐµÑ‚ÑÑ, Ð¼Ñ‹ ÑÑ‚Ð¾ ÑƒÐ¶Ðµ Ð¾Ð±ÑÑƒÐ¶Ð´Ð°Ð»Ð¸. ÐœÐ¾Ð¶ÐµÑ‚, Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ð¼ Ð¸Ð½Ð°Ñ‡Ðµ?"
    context.chat_data["last_reply"] = reply

    if module == 0 and turns >= 3 and parse_transition(reply) is None:
        log.info("Regenerating â€” no transition phrase found")
        messages.insert(1, {"role": "system", "content": "ÐŸÐµÑ€ÐµÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐ¹, Ð´Ð¾Ð±Ð°Ð²ÑŒ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°."})
        reply = ask_llm(messages)

    new_module = parse_transition(reply)
    if new_module is not None:
        context.chat_data.update({"module": new_module, "turns_in_module": 0})

    add_to_memory_safely(user_id, reply)
    convo.append({"role": "assistant", "content": reply})
    context.chat_data["convo"] = convo[-CONTEXT_WINDOW_SIZE * 2 :]

    await update.message.reply_text(reply)

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
    log.exception("Unhandled exception: %s", context.error)
    if hasattr(update, "message") and update.message:
        await update.message.reply_text("Ð£Ð¿Ñ, Ñ‡Ñ‚Ð¾â€‘Ñ‚Ð¾ Ð¿Ð¾ÑˆÐ»Ð¾ Ð½Ðµ Ñ‚Ð°Ðº. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÐµÑ‰Ñ‘ Ñ€Ð°Ð· Ð¿Ð¾Ð·Ð´Ð½ÐµÐµ.")

async def init_commands(app):
    await app.bot.set_my_commands([BotCommand("start", "ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð´Ð¸Ð°Ð»Ð¾Ð³ Ñ ÐÐ¹Ð²Ð¸")])

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  HELPERS  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def ask_llm(messages: List[Dict[str, Any]]) -> str:
    try:
        resp = client.chat.completions.create(
            model=FINETUNED_MODEL,
            messages=messages,
            temperature=0.7,
            top_p=0.95,
            frequency_penalty=0.35,
            presence_penalty=0.55,
            max_tokens=400,
            timeout=10,
        )
        return resp.choices[0].message.content.strip()
    except Exception as e:
        log.error("ChatCompletion error: %s", e)
        return "Ð˜Ð·Ð²Ð¸Ð½Ð¸, Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¿Ð¾Ð·Ð¶Ðµ."

def parse_transition(text: str) -> Optional[int]:
    match = re.search(r"ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð½Ð° Ð¼Ð¾Ð´ÑƒÐ»ÑŒ (\d+)\s*$", text)
    return int(match.group(1)) if match else None

def add_to_memory_safely(user_id: str, text: str) -> None:
    try:
        add_to_memory(user_id, text)
    except Exception as e:
        log.error("Failed to add to memory: %s", e)

def recall_safely(user_id: str, query: str, k: int) -> List[str]:
    try:
        return recall(user_id, query, k=k)
    except Exception as e:
        log.error("Failed to recall memory: %s", e)
        return []

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  MAIN  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def main() -> None:
    try:
        create_collection()
    except Exception as e:
        log.warning("create_collection failed: %s", e)

    app = (
        ApplicationBuilder()
        .token(TELEGRAM_TOKEN)
        .post_init(init_commands)
        .build()
    )
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.add_error_handler(error_handler)

    log.info("ðŸš€ Ivy bot started")
    app.run_polling()

if __name__ == "__main__":
    main()
